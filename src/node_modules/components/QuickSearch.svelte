<div class="absolute inset-0 h-screen flex justify-center z-50">
    <div transition:fade="{{ duration: 250 }}" class="absolute inset-0 h-screen bg-black opacity-50" on:click={close}></div>
    <div transition:fly="{{ y: -20, duration: 250 }}" class="rounded overflow-hidden absolute shadow" style="top: 5rem; width: 600px;">
        <div class="relative">
            <input on:keydown={enter} bind:value={search_value} bind:this={quick_search_input} class="bg-gray-100 dark:bg-gray-700 outline-none py-3 pr-4 pl-10 block appearance-none leading-normal w-full" type="search" placeholder="{$_.capital('search')}" />
            <div class="pointer-events-none absolute inset-y-0 left-0 pl-3 flex items-center">
                <svg class="fill-current pointer-events-none w-5 h-5 opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M16.32 14.9l1.1 1.1c.4-.02.83.13 1.14.44l3 3a1.5 1.5 0 0 1-2.12 2.12l-3-3a1.5 1.5 0 0 1-.44-1.14l-1.1-1.1a8 8 0 1 1 1.41-1.41l.01-.01zM10 16a6 6 0 1 0 0-12 6 6 0 0 0 0 12z" />
                </svg>
            </div>
        </div>
        <div class="results-list">
            {#await search(search_value)}
                <div class="bg-gray-100 dark:bg-gray-700 flex justify-center pt-2 pb-4">
                    <Loading />
                </div>
            {:then results}
                {#each results as {id, name, cover}}
                    <a rel=prefetch transition:slide href="/series/{id}/{slugify(name)}" class="bg-gray-100 dark:bg-gray-700 flex items-center relative px-4 pt-2 first-child:pt-3 pb-2 hover:bg-gray-200 dark:hover:bg-gray-800 h-16 relative" on:click={close}>
                        <img class="w-12 rounded" src="{cdn(cover, { resize: '96,96' })}" alt="Cover for {name}"/>
                        <div class="ml-4 overflow-hidden">
                            <div class="font-semibold truncate">{name}</div>
                            <div class="text-sm">Manga</div>
                        </div>
                    </a>
                {/each}
                <a rel=prefetch href="/search{search_value !== '' ? `?name=${search_value}` : ''}" class="bg-gray-100 dark:bg-gray-700 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-800 text-sm py-2" on:click={close}>
                    {$_('advanced_search')}
                </a>
            {/await}
        </div>
    </div>
</div>

<script>
    import { goto } from '@sapper/app'
    import { cdn } from 'cdn.js'
    import { _ } from 'svelte-i18n'
    import { slugify } from 'utils'
    import Loading from 'components/Loading.svelte'
    import { slide, fade, fly } from 'svelte/transition'
    import { createEventDispatcher, onMount } from 'svelte'

    let search_value = ''
    let quick_search_input
    let controller = new AbortController()
    const dispatch = createEventDispatcher()

    const enter = ({ key }) => {
    	if (key === 'Enter') {
    		close()
    		const url = search_value !== '' ? `/search?name=${search_value}` : `/search`
    		goto(url)
    	}
    }

    const search = async value => {
    	controller.abort()
    	if (value === '') return []
        
    	controller = new AbortController()
    	const signal = controller.signal
    	const res = await fetch(`https://api.manga.cat/v1/series?query=name__icontains:${value}&limit=5`, {signal})
    	return await res.json()
    }

    const close = () => { dispatch('close') }
    
    onMount(() => { 
    	quick_search_input.focus() 

    	return () => controller.abort()
    })
</script>