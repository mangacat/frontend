<div class="relative" bind:this={container_elem}>
    <button bind:this={button_elem} type="button" class="text-left w-full bg-white dark:bg-gray-700 shadow flex items-center py-2 px-3 rounded outline-none focus:shadow-outline {isOpen ? 'shadow-lg' : ''}" on:click={toggle}>
        <div class="flex-grow {value.length !== 0 ? '-mb-1' : ''}">
            {#if value.length !== 0}
                {#each value as val}
                    <div class="inline-flex items-center bg-gray-200 dark:bg-gray-800 rounded px-2 py-1 mr-2 mb-1 leading-none">
                        <span class="mr-1">
                            {searchProperty == '' ? val : val[searchProperty]}
                        </span>
                        <svg class="w-2 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 352 512" on:click|stopPropagation|preventDefault={() => select(val)}>
                            <path d="M242.72 256l100.07-100.07c12.28-12.28 12.28-32.19 0-44.48l-22.24-22.24c-12.28-12.28-32.19-12.28-44.48 0L176 189.28 75.93 89.21c-12.28-12.28-32.19-12.28-44.48 0L9.21 111.45c-12.28 12.28-12.28 32.19 0 44.48L109.28 256 9.21 356.07c-12.28 12.28-12.28 32.19 0 44.48l22.24 22.24c12.28 12.28 32.2 12.28 44.48 0L176 322.72l100.07 100.07c12.28 12.28 32.2 12.28 44.48 0l22.24-22.24c12.28-12.28 12.28-32.19 0-44.48L242.72 256z" />
                        </svg>
                    </div>
                {/each}
            {:else}
                Select
            {/if}
        </div>
        <div class="w-3 flex-grow-0">
            <svg class="icon w-3 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                <path d="M31.3 192h257.3c17.8 0 26.7 21.5 14.1 34.1L174.1 354.8c-7.8 7.8-20.5 7.8-28.3 0L17.2 226.1C4.6 213.5 13.5 192 31.3 192z" />
            </svg>
        </div>
    </button>
    {#if isOpen}
        <div transition:slide={{ duration: 400 }} bind:this={dropdown_elem} class="my-2 z-40 rounded py-3 px-2 w-full bg-white dark:bg-gray-700 shadow-lg">
            <input bind:this={input_elem} bind:value={search} on:keydown={inputListener} class="py-2 px-3 mb-2 rounded w-full bg-gray-200 dark:bg-gray-800 outline-none focus:shadow-outline" type="search" />
            {#if filteredOptions.length > 0}
                <ul bind:this={options_elem} class="overflow-y-scroll" style="max-height: 200px;">
                    {#each filteredOptions as option, i}
                        <li on:mouseover={() => highlightedIndex = i} on:click={() => select(option)} class="py-2 px-3 cursor-pointer rounded {i === highlightedIndex ? 'bg-gray-200 dark:bg-gray-800' : ''}">
                            {searchProperty == '' ? option : option[searchProperty]}
                        </li>
                    {/each}
                </ul>
            {:else}
                No results found for {search}
            {/if}
        </div>
    {/if}
</div>

<svelte:window on:click={outside_click}></svelte:window>

<script>
    import Popper from 'popper.js'
    import { tick } from 'svelte'
    import { slide } from 'svelte/transition'

    export let value = []
    export let options = []
    export let filterFunction = (search, options) => options.filter(elem => elem.toLowerCase().includes(search.toLowerCase()))
    export let searchProperty = ''

    let isOpen = false
    let search = ''
    let highlightedIndex = 0
    let popper

    let button_elem
    let dropdown_elem
    let input_elem
    let options_elem
    let container_elem

    $: filteredOptions = filterFunction(search, options).filter(option => { return !value.includes(option) })

    const outside_click = e => {
    	if (e.target === container_elem || container_elem.contains(e.target)) return
    	else close()
    }

    const select = val => {
    	if (value.includes(val)) {
    		value = value.filter(elem => elem != val)
    	} else {
    		value = [...value, val]
    	}
    	popper.scheduleUpdate()
    }

    const highlight = index => {
    	highlightedIndex = index

    	if (highlightedIndex < 0) {
    		highlightedIndex = filteredOptions.length - 1
    	}

    	if (highlightedIndex > filteredOptions.length - 1) {
    		highlightedIndex = 0
    	}

    	scrollToHighlighted()
    }

    const open = async () => {
    	if (isOpen) return
    	isOpen = true
    	if (popper) popper.destroy()
    	await tick()
    	popper = new Popper(button_elem, dropdown_elem, { placement: 'bottom' })
    	popper.scheduleUpdate()
    	input_elem.focus()
    	scrollToHighlighted()
    }

    const close = () => {
    	if (!isOpen) return
    	isOpen = false
    }

    const toggle = () => {
    	if (isOpen) close()
    	else open()
    }

    const inputListener = e => {
    	if (e.key === 'ArrowDown') {
    		highlight(highlightedIndex + 1)
    	} else if (e.key === 'ArrowUp') {
    		highlight(highlightedIndex - 1)
    	} else if (e.key === 'Enter') {
    		e.preventDefault()
    		if (filteredOptions.length && highlightedIndex < filteredOptions.length) select(filteredOptions[highlightedIndex])
    	} else if (e.key === 'Escape') {
    		close()
    	}
    }

    const scrollToHighlighted = () => {
    	if (options_elem && options_elem.children.length) {
    		options_elem.children[highlightedIndex].scrollIntoView({
    			block: 'nearest'
    		})
    	}
    }
</script>